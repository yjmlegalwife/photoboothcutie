<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cute Photobooth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #fff0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #ff6e6e;
    }
    button, select, input[type="file"] {
      background-color: #ff6e6e;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 30px;
      font-size: 1rem;
      margin: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #ff4e4e;
    }
    #video {
      width: 600px;
      max-width: 90vw;
      border-radius: 20px;
      border: 5px solid #ff8f8f;
      margin-top: 10px;
      transform: scaleX(-1); /* Mirror effect */
      object-fit: cover;
    }
    #countdown {
      font-size: 6rem;
      color: #ff6e6e;
      margin: 20px 0;
    }
    .photostrip img {
      margin-bottom: 15px;
      width: 360px;
      border-radius: 15px;
      border: 4px solid #ff8f8f;
    }
    .photo-buttons {
      margin-bottom: 30px;
    }
    #flash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      display: none;
      z-index: 10;
    }
  </style>
</head>
<body>

<h1>ðŸ“¸ Cute Photobooth</h1>

<div>
  <label>Countdown:</label>
  <select id="countdownTime">
    <option value="3">3 sec</option>
    <option value="5">5 sec</option>
    <option value="8">8 sec</option>
  </select>

  <label>Template:</label>
  <input type="file" id="templateUpload" accept="image/*">
</div>

<div id="flash"></div>
<div id="countdown"></div>
<video id="video" autoplay playsinline muted></video><br>

<button onclick="startPhotoSession()">Start Photobooth!</button>
<button onclick="downloadPhotostrip()">Download Photostrip</button>

<div class="photostrip" id="photostrip"></div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let countdownEl = document.getElementById('countdown');
let flash = document.getElementById('flash');
let photostrip = document.getElementById('photostrip');
let countdownTime = document.getElementById('countdownTime');
let templateImage = null;

// --- Correct camera access here ---
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: false
})
.then(stream => {
  video.srcObject = stream;
  video.play();
})
.catch(err => {
  console.error('Error accessing camera:', err);
  alert('Cannot access camera. Please allow camera permission.');
});

// Handle template upload
document.getElementById('templateUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    templateImage = new Image();
    templateImage.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

// Start photobooth session
async function startPhotoSession() {
  let countdown = parseInt(countdownTime.value);

  while (countdown > 0) {
    countdownEl.textContent = countdown;
    countdownEl.style.transform = 'scale(1.2)';
    await new Promise(res => setTimeout(res, 800));
    countdownEl.style.transform = 'scale(1)';
    await new Promise(res => setTimeout(res, 200));
    countdown--;
  }

  countdownEl.textContent = '';
  takePhoto();
}

// Take a photo
function takePhoto() {
  flashScreen();

  // Set canvas size
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  // Mirror the context
  ctx.save();
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);

  // Draw video frame
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  ctx.restore();

  // If template uploaded, draw it ON TOP
  if (templateImage) {
    ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);
  }

  let imgUrl = canvas.toDataURL('image/png');
  let img = document.createElement('img');
  img.src = imgUrl;
  photostrip.appendChild(img);
}

// Flash effect
function flashScreen() {
  flash.style.display = 'block';
  setTimeout(() => {
    flash.style.display = 'none';
  }, 100);
}

// Download all photos
function downloadPhotostrip() {
  const images = photostrip.querySelectorAll('img');
  if (images.length === 0) return;

  const downloadCanvas = document.createElement('canvas');
  const ctx2 = downloadCanvas.getContext('2d');
  const imgWidth = images[0].width;
  const imgHeight = images[0].height;
  const gap = 20;
  downloadCanvas.width = imgWidth;
  downloadCanvas.height = (imgHeight + gap) * images.length - gap;

  images.forEach((img, index) => {
    ctx2.drawImage(img, 0, index * (imgHeight + gap), imgWidth, imgHeight);
  });

  const link = document.createElement('a');
  link.download = 'photostrip.png';
  link.href = downloadCanvas.toDataURL();
  link.click();
}
</script>

</body>
</html>
