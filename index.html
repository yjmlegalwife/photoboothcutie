<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Cute Photobooth</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #fff0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
      margin: 0;
      padding: 20px;
    }
    h1 {
      color: #ff6e6e;
    }
    button, select, input[type="file"] {
      background-color: #ff6e6e;
      color: white;
      border: none;
      padding: 12px 20px;
      border-radius: 30px;
      font-size: 1rem;
      margin: 10px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background-color: #ff4e4e;
    }
    #video {
      width: 600px;
      max-width: 90vw;
      border-radius: 20px;
      border: 5px solid #ff8f8f;
      margin-top: 10px;
      transform: scaleX(-1); /* Mirror effect */
      object-fit: cover;
    }
    #countdown {
      font-size: 6rem;
      color: #ff6e6e;
      margin: 20px 0;
      transition: transform 0.2s;
    }
    .photo-buttons {
      margin-bottom: 30px;
    }
    #flash {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: white;
      display: none;
      z-index: 10;
    }
    #photostrip {
      margin-top: 20px;
    }
    #photostrip img {
      width: 300px;
      border-radius: 15px;
      border: 4px solid #ff8f8f;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

<h1>ðŸ“¸ Cute Photobooth</h1>

<div>
  <label>Countdown:</label>
  <select id="countdownTime">
    <option value="3">3 sec</option>
    <option value="5">5 sec</option>
    <option value="8">8 sec</option>
  </select>

  <label>Template:</label>
  <input type="file" id="templateUpload" accept="image/*">
</div>

<div id="flash"></div>
<div id="countdown"></div>
<video id="video" autoplay playsinline muted></video><br>

<button onclick="startPhotoSession()">Start Photobooth!</button>
<button onclick="downloadPhotostrip()">Download Photostrip</button>
<button onclick="downloadVideo()">Download Session Video</button>

<div id="photostrip"></div>

<canvas id="canvas" style="display:none;"></canvas>

<script>
let video = document.getElementById('video');
let canvas = document.getElementById('canvas');
let ctx = canvas.getContext('2d');
let countdownEl = document.getElementById('countdown');
let flash = document.getElementById('flash');
let photostrip = document.getElementById('photostrip');
let countdownTime = document.getElementById('countdownTime');
let templateImage = null;
let capturedPhotos = [];

let mediaRecorder;
let recordedChunks = [];

// --- Access Camera ---
navigator.mediaDevices.getUserMedia({
  video: { facingMode: "user" },
  audio: false
})
.then(stream => {
  video.srcObject = stream;
  video.play();
})
.catch(err => {
  console.error('Error accessing camera:', err);
  alert('Cannot access camera. Please allow camera permission.');
});

// --- Handle Template Upload ---
document.getElementById('templateUpload').addEventListener('change', (e) => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(event) {
    templateImage = new Image();
    templateImage.src = event.target.result;
  };
  reader.readAsDataURL(file);
});

// --- Start Photobooth Session ---
async function startPhotoSession() {
  capturedPhotos = [];
  recordedChunks = [];
  photostrip.innerHTML = '';

  startRecording();

  for (let i = 0; i < 4; i++) {
    await countdownAndPhoto();
    await new Promise(res => setTimeout(res, 500)); // slight wait after photo
  }

  stopRecording();
}

// --- Countdown and Take Photo ---
async function countdownAndPhoto() {
  let count = parseInt(countdownTime.value);
  while (count > 0) {
    countdownEl.textContent = count;
    countdownEl.style.transform = 'scale(1.2)';
    await new Promise(res => setTimeout(res, 800));
    countdownEl.style.transform = 'scale(1)';
    await new Promise(res => setTimeout(res, 200));
    count--;
  }
  countdownEl.textContent = '';
  takePhoto();
}

// --- Take a Photo ---
function takePhoto() {
  flashScreen();

  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;

  ctx.save();
  ctx.translate(canvas.width, 0);
  ctx.scale(-1, 1);
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  ctx.restore();

  if (templateImage) {
    ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);
  }

  const imgUrl = canvas.toDataURL('image/png');
  capturedPhotos.push(imgUrl);

  // Show preview
  const img = document.createElement('img');
  img.src = imgUrl;
  photostrip.appendChild(img);
}

// --- Flash Effect ---
function flashScreen() {
  flash.style.display = 'block';
  setTimeout(() => {
    flash.style.display = 'none';
  }, 100);
}

// --- Download Photostrip ---
function downloadPhotostrip() {
  if (capturedPhotos.length === 0) {
    alert('No photos to download!');
    return;
  }

  const width = 300;
  const height = 400; // Approximate, depends on your video size
  const spacing = 20;
  const totalHeight = (height + spacing) * capturedPhotos.length - spacing;

  const stripCanvas = document.createElement('canvas');
  const stripCtx = stripCanvas.getContext('2d');
  stripCanvas.width = width;
  stripCanvas.height = totalHeight;

  let loaded = 0;
  capturedPhotos.forEach((src, index) => {
    const img = new Image();
    img.onload = () => {
      stripCtx.drawImage(img, 0, index * (height + spacing), width, height);
      loaded++;
      if (loaded === capturedPhotos.length) {
        const link = document.createElement('a');
        link.download = 'photostrip.png';
        link.href = stripCanvas.toDataURL();
        link.click();
      }
    };
    img.src = src;
  });
}

// --- Screen Recording ---
function startRecording() {
  const stream = document.body.captureStream(30);
  mediaRecorder = new MediaRecorder(stream, { mimeType: 'video/webm' });

  mediaRecorder.ondataavailable = function(e) {
    if (e.data.size > 0) {
      recordedChunks.push(e.data);
    }
  };

  mediaRecorder.start();
}

function stopRecording() {
  if (mediaRecorder && mediaRecorder.state !== 'inactive') {
    mediaRecorder.stop();
  }
}

// --- Download Session Video ---
function downloadVideo() {
  if (recordedChunks.length === 0) {
    alert('No recording available!');
    return;
  }

  const blob = new Blob(recordedChunks, { type: 'video/webm' });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  link.download = 'session_video.webm';
  link.click();

  URL.revokeObjectURL(url);
  recordedChunks = []; // Clear after download
}
</script>

</body>
</html>

